# RID Qualifier Host

`rid_qualifier host` is a development-level web server that provides endpoint to initialize the automated testing of the rid qualifier. 
This PR includes the initial setup for the web-server that can be run locally on your system via the (run_locally.sh)[run_locally.sh] script. 

## Architecture

This project will create the following environment:

* redis Container: A redis server to handle background tasks.

* rq-worker Container: A container to run redis queue worker processes.

* rid-host Container: A flask application which accepts KML files or flight states' json files as input, collect auth and config spec from user and allow user to executes RID Qualifier test. Once task finishes successfully, report file becomes available to download from the UI.

This application accepts Auth2 credentials for user specific login. The process to authenticate using Auth2 is described (here)[/LOGIN.md]. If Auth2 credentials are not provided application uses `Local User` session by default.

* Additionally, you need to bring up (rid_qualifier mock instance)[monitoring/rid_qualifier/mock/run_locally.sh] to produce a mock RID system for use with rid_qualifier. The instructions to bring up the rid_qualifier mock instance can be found (here)[monitoring/rid_qualifier/mock/README.md].

### Input Files

Accepted input files are, either valid flight records or KML files in the format mentioned (here)[/rid_rualifier/README.md/#Create-Flight-Record-from-KML].

When KML files are provided as input, `Flight records json` files are generated from the KML and kept into user specific `flight_records` folder on the RID host. Once records are generated, these are available on the UI for selection during test execution.

### Test Execution

When the user requests the execution of a test, the rid_qualifier host sends it as a message to the `redis` server Message Queue, which is then handled by the worker process running on the `rq-worker`. This job takes some amount of time, during this time UI keeps sending requests to rid_qualifier server to check the job status. rid_qualifier host then checks the Redis container for the job progress and returns current status to the UI. Once job finishes successfully, RID Host generates resulting report from the job response and keep it in user specific `tests` folder on rid-host, and sends it as a response to the UI.

All the tests run by a user are the available to download from the UI.

## Run via Docker

Change the root directory to dss/. Run the following command to start new containers:

```bash
 ./monitoring/rid_qualifier/host/run_locally.sh
```

## Task Description

You can now test the application by uploading flight states json files. There must be at least one such input json file w.r.t each USS target provided in [Configuration object below](#user-config-information).
Input files are **required** to execute the task. Follow the instructions below to generate [Flight states input files](#flight-states-input-files). 

## Flight states input files

RID host requires flight state input files to run the test executor. These files can be generated by running (flight_data_generator)[monitoring/rid_qualifier/flight_data_generator.py] as below:

```bash
    python monitoring/rid_qualifier/flight_data_generator.py
```

Resulting files will be generated under `monitoring/rid_qualifier/test_definitions/che/aircraft_states`.

## User Config information

rid_qualifier host needs a configuration object and an auth spec (single string e.g. `NoAuth()`) in order to run. Configuration object is a simple nested json string which should have at least a list of `injection_targets` and `observers`. A sample configuration object can be found (here)[https://github.com/interuss/dss/blob/48ce96b1a50603b810ead672a7c8dbca4a7c367c/monitoring/rid_qualifier/run_locally.sh#L18].

A task may take few minutes to finish. A new task can not be launched until current task ends.

Once the task is successful, resulting report can be retrieved from the web interface by clicking the `Get Result` button. A sample response report.json can be downloaded by ticking `Sample Report` checkbox.
